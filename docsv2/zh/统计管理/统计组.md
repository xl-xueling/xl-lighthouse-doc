## 统计组的作用

统计组是系统中的一个核心概念，它是基于同一份元数据的多个统计项的合集。统计组主要是面向数据指标的创建者和接入者使用的，而对于数据指标使用方，统计组是一个完全隐藏的概念。

大部分业务场景基于同一份原始消息数据并不仅仅只有一个数据指标需求，如果每个数据指标的实现都需要重复的上报原始消息，除了会带来很多不必要的网络传输，也会给业务方接入、原始数据校验带来很多不便。

每个统计组都有相应的元数据配置信息，类似关系数据库中的表结构，但它与关系数据库中的表不同，统计组是一个虚拟的、轻量级概念，它并不真实存在，它的字段信息可以根据业务需要随时动态扩充。

在创建统计项时，该统计项所依赖的字段（包括stat属性和dimens属性中所有包含的字段）都必须在统计组中存在。如果统计组中已包含所有要创建统计项的依赖字段，则该统计项可以直接创建，创建完成后立即生效。如果统计项依赖的字段在统计组中不存在

使用统计组没有必要与业务方自己的表结构保持一致，只需要创建与统计相关的字段即可，此外对于一些一对多、多对多的关系，一个统计组如果不容易解决所有问题，则可以拆分成多个统计组分开实现。

## 创建统计组

工程管理员进入“工程管理”页面，点击页面上的“创建统计组”按钮，弹出统计组创建对话框，录入以下信息。

统计组基础信息包括：Token、字段信息和描述信息。

1、Token

+ 必要字段，格式为：Nec:order_stat，其中Nec为系统部署时随机生成的域前缀（不可修改），order_stat为统计组标识，只允许英文、数字、下划线，第一个字符为英文字母，长度限制：5 ~ 25个字符之间。

2、字段信息

+ 字段信息包括：字段名称、字段类型和字段注释；
+ 字段名称必须使用英文、数字、下划线，长度限制：3 ~ 15个字符；
+ 字段类型分为String类型和Number类型，务必注意：需要进行sum、max、min、avg、seq等数值运算的字段必须为Number类型，其他不参与数值运算的字段均可指定为String类型；
+ Number类型是Long、Int、Float、Double等数值类型的合称，String类型是其他非数值类型的合称；
+ 字段数量没有实际限制，单个统计组不建议使用过多字段，如果字段过多（超过100个）建议拆分成多个统计组；

3、描述信息

用于描述当前统计组的作用，请根据实际场景填写。

## 修改统计组

统计组创建完成后，工程管理员可进入“工程管理”页面，选择相应统计组，点击“修改统计组”按钮执行修改操作。

## 删除统计组

+ 工程管理员可进入“工程管理”页面，选择相应统计组，点击“更多”按钮，选择“删除统计组”菜单项可执行删除操作；
+ 系统在执行删除逻辑前首先判断当前统计组是否包含统计项，如果包含统计项则禁止删除；
+ 删除操作不可回退；

## 纬度值清理

如果需要清理内置筛选组件中的展示值，统计工程管理员可以在“工程管理” -> 选择相应统计组 -> 点击"更多"按钮 -> 点击"清理纬度值"菜单项，打开清理纬度值对话框。

清理纬度值操作不会影响统计结果，只影响内置筛选组件中的展示逻辑。

清理纬度值的方式分为两种：

+ 键值清理

键值清理是单个纬度值的清理方式，适合删除少量维度值信息。

在“键值清理”选项卡，选择相应维度字段，查找要清理的纬度值，然后点击删除按钮即可。

+ 批量清理

批量清理是完全删除当前统计组所有维度字段的数据，适合大批量删除历史纬度值信息的场景。删除操作不会影响这些维度的统计结果，随着原始消息的后续接入，维度字段会重新显示到筛选组件中。删除操作以前的统计结果均可正常展示。

在“批量清理”选项卡，点击“全部删除”按钮即可。

## 限流保护机制


### 限流机制的作用

为了提升整体服务的稳定性，避免因为不当的接入方式造成对整个服务所有统计任务的影响，系统具有较为完善的限流保护机制。

### 限流策略

系统包含两种限流策略：统计组消息量限流和统计项结果量限流。当触发限流策略后相应的统计计算将会停止，15分钟后自动恢复到正常状态，如果依然超出阈值则会继续限流15分钟，如此反复。

+ 统计组消息量限流

统计组消息量限流是针对统计组对应的原始消息单位时间接收数量的限流策略。如果一个统计组每秒的消息量超出阈值则会触发该限流策略，触发该限流策略后，统计组消息将会被系统抛弃，从而影响统计组下所有统计项的指标统计。

+ 统计结果量限流

统计项结果量限流是针对每个统计项生成的统计结果数量的限流策略。在系统中每个统计项的统计结果数量由统计周期和统计维度两个因素决定。比如：统计项"每天的uv数据"，一天只生成一条统计结果。统计项”每分钟的uv数据“则每天生成1440条结果，而统计项”每分钟各城市的uv数据“假设100城市有数据，则该统计项大概会对应1440 * 100条结果。

### 限流记录

工程管理员进入相应统计项视图页面，点击“限流记录图标”可查看当前统计项以及所在统计组的限流记录信息。

### 阈值调整

系统部署完成后，默认统计组消息量限流阈值：30000/每秒，每个统计项统计结果量限流阈值：3000/每秒，如果您的业务场景超出此阈值可以根据需要进行调整。

1、集群统一调整默认限流阈值

如果系统部署完成后，希望统一调整限流阈值可进入系统部署目录./bin/templates/lighthouse/conf/

按照部署模式选择：ldp-site-cluster.xml(集群模式配置文件)或ldp-site-standalone.xml(单机模式配置文件)修改以下配置：

```
 <property>
        <name>limiting.group.message.size.per.sec</name>
        <value>30000</value>
    </property>
    <property>
        <name>limiting.stat.result.size.per.sec</name>
        <value>3000</value>
    </property>
```
2、工程管理员申请调整限流阈值

工程管理员进入“工程管理”页面 -> 选择相应统计组 -> 点击"更多"按钮 -> 选择"限流管理"菜单项，可对当前统计组的限流策略阈值进行调整。

在“限流管理”对话框，点击下方“限流阈值修改”折叠栏，选择相应限流策略，并填写表单信息后提交工单，工单申请完成后需要由运维管理员审批通过才可生效。