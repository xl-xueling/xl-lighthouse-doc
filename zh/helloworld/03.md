# 范例三：移动端订单支付状态数据监控

---
XL-LightHouse接入只需要三步操作
- 在Web页面创建统计工程、统计组并配置相应的元数据结构；
- 在Web页面创建统计项；
- 调用SDK上报原始数据消息；

然后就可以在Web页面查看统计结果了。

**在Web服务中依次创建(统计工程 -> 统计组 -> 统计项)后，为了测试方便，您可以下载工程代码，直接使用com.dtstep.lighthouse.core.test.stat.HelloWorld中的单元测试方法，然后修改RPC服务IP地址和统计组的Token及秘钥，运行即可，Web端结果展示约有1分钟延迟！**

**使用过程中如有问题，及时反馈，本人一定第一时间响应~**

---

## 订单支付状态数据监控

### 统计需求梳理

我这里假设订单有四种状态：支付成功、支付失败、超时未支付、订单取消。

```
订单量：
1、每10分钟_各状态_订单量
2、每10分钟_各商户_各状态_订单量
1、每天_各状态_订单量
2、每天_各商户_各状态_订单量

订单异常率:
1、每10分钟_订单异常率
2、每10分钟_各商户_订单异常率
3、每小时_订单异常率
4、每天_订单异常率
5、每天_各商户_订单异常率

支付失败用户数统计:
1、每5分钟_支付失败用户数
```

### 定义元数据

| 字段 | 字段类型 | 描述 |  |
| --- | --- | --- | --- |
| userId | string | 用户ID |  |
| province | string | 用户所在省份 |  |
| city | string | 用户所在城市 |  |
| dealerId | string | 商户ID |  |
| orderId | string | 订单ID |  |
| state | string | 订单支付状态 | 1:支付成功、2：支付失败、3：超时未支付 4：订单取消 |

+ 消息上报时机

该类订单支付状态变更的需求可分为两种上报时机：
1、订单状态发生变化时上报，使用该上报方式一笔订单可能对应多条状态变更消息。
2、订单确定最终状态时上报，使用该上报方式一笔订单只对应一条状态变更消息。
**上报时机的选择决定了统计原始消息数据本身，也决定了统计项的配置方式和最终的统计结果。**

+ 跨周期统计问题

关于此类“状态变更业务场景”的数据统计会涉及跨统计周期的问题，XL-LightHouse的每一条元数据消息都需要一个时间戳参数，内部的运算逻辑也完全基于这个时间戳来划分时间窗口。在这种“状态变更业务场景”中使用时，状态变更可能会横跨不同的统计周期，比如我们要计算“每小时_异常支付订单数量”这个数据指标，订单创建消息可能是在10点，订单支付失败的消息可能是在12点，这个时候如果您的业务期望这个异常值统计在订单创建的统计周期内，就传订单创建的时间戳。如果是期望统计在订单异常消息的统计周期内，就传异常消息本身的时间戳。

### 模拟上报
