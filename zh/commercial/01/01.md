# 自定义视图

![XL-LightHouse](https://lighthousedp-1300542249.cos.ap-nanjing.myqcloud.com/screenshot_v2/38.jpg)

## 1、视图的作用

+ 视图可以为数据指标提供更多的图表展示形式；
+ 可以根据需要将多个数据指标聚合到一个视图内或一个图表内展示；  
+ 对于包含相同统计维度的数据指标，可以实现多个统计指标之间随筛选参数变化而联动的效果；
+ 在视图中，数据指标的统计维度可分为（筛选维度和非筛选维度），筛选维度即在查询数据时按照筛选框的交互形式设置，非筛选维度是按照预定义设置显示（不展示筛选组件）。
+ 视图可以实现页面的自定义布局；
+ 视图可以被添加到指标集中；

## 2、视图管理

### 2.1 创建视图

创建视图需要指定信息：

+ 视图名称
+ 描述信息

![XL-LightHouse](https://lighthousedp-1300542249.cos.ap-nanjing.myqcloud.com/5001/1.jpg)

### 2.2 视图的状态

视图包含两种状态：

+ 未发布状态
  
  未发布表示当前视图还处于"开发设计"阶段，未发布视图在"全部视图"列表对其他用户不可见，如果将未发布视图添加到指标集中，此时无法查看该视图（在指标集中只能查看已发布视图的最新版本）。

+ 已发布状态
  
  已发布状态的视图表示已正式对外发布，对其他用户可见，其他用户可执行申请权限、查看视图、添加到指标集等操作。

### 2.3 视图的版本

在视图设计页面点击"保存"按钮可以为当前视图创建快照（版本），用户在版本下拉框可以切换查看不同版本的渲染效果。

在视图设计页面点击"预览"按钮会在新标签页打开当前版本的预览页面。

在视图设计页面点击"发布"按钮会将当前视图设置为已发布状态，并将当前版本作为最新发布版本，拥有该视图访问权限的其他用户可以查看到该版本的渲染效果。

如果您在视图设计时希望回退到某个版本，可以点击"版本"下拉框切换到该版本，并重新点击保存按钮，即会在该版本数据的基础上创建出一个新版本（新版本与所选择版本的数据完全相同）。

## 3、视图组件

视图中的组件分为两类：筛选组件（包括：日期筛选组件、输入框、默认维度筛选组件、自定义维度筛选组件）以及 图形组件（包括：折线图、饼状图、面积图、柱状图、柱状排序图、漏斗图、表格和扩展素材）。

系统中将除了基础图表之外的其他展示形式叫做扩展素材，扩展素材目前只包含一个卡片素材，后续根据用户反馈，会陆续增加更多实用的图形展示形式。

在视图中每个组件都可以进行自定义设置，设置项依据组件类型而有所不同。

## 4、筛选组件

筛选组件分为默认筛选组件和自定义筛选组件。

默认筛选组件是随着统计组的数据接入，按照统计项维度配置而采集的相应维度字段的数据。
自定义筛选组件是用户在系统内自己创建的筛选组件。

两种类型的筛选组件都可以在视图中被引用，并且不同统计组之间，如果确认维度字段数据相同的情况下也可以交叉使用。

### 4.1 筛选组件与图形组件绑定

筛选组件添加到视图中，默认不会生效。需要在图形组件中进行维度参数的绑定才可以生效。

筛选组件与图形组件绑定操作步骤：

+ 添加图形组件和筛选组件到视图中；
+ 选择相应的图形组件，点击"组件配置"；
+ 在图形组件中绑定相应的统计项；  
+ 在"数据配置"选项卡，筛选项设置栏目选择要绑定的筛选组件，并添加关联的维度参数，如果多维度使用分号分割，点击"关联"。
+ 点击确定保存；

对于包含多个统计维度的统计项，系统将多个维度分为：筛选维度和非筛选维度，两者的设置是互相联动的。当设置某个维度为筛选维度时，下面的非筛选项会自动删除该维度。

在图形组件的筛选项设置栏目中默认会将当前视图所添加的所有维度筛选组件都显示出来，您只要绑定实际需要的筛选组件即可，筛选组件只有在"已关联"状态下才会与当前图表绑定。

一个筛选组件可以和多个图形组件进行绑定，当用户执行筛选操作时，每个图形都会重新渲染。

![XL-LightHouse](https://lighthousedp-1300542249.cos.ap-nanjing.myqcloud.com/5001/2.jpg)

## 5、图形组件

系统中的图形组件按照渲染的时间特性分为两类：

### 5.1 时间段类(Time-Period)渲染组件

包括：折线图、面积图、柱状图、表格。

时间段类渲染组件是按照起止时间展示连续时间序列的统计数据。

举例，比如有以下统计项：

```
统计项1：<stat-item title="每天_订单量" stat="count()" /> TimeParam:1-day
统计项2：<stat-item title="每天_销售额" stat="sum(amount)" /> TimeParam:1-day
统计项3：<stat-item title="每分钟_各省份_pv数据" stat="count()" dimens="province" /> TimeParam:1-minute
统计项4：<stat-item title="每小时_各省份_uv数据" stat="bitcount(uid)" dimens="province" /> TimeParam:1-hour
```

针对天粒度的统计指标（如上述统计项1、统计项2）使用折线图展示最近一周每天的订单量数据、最近一个月每天的销售额数据，时间周期为最近一周和最近一个月；

针对分钟粒度、小时粒度的统计指标（如上述统计项3、统计项4）使用折线图展示最近一天各省份的每分钟的pv数据和每小时的uv数据，时间周期为最近一天；

### 5.2 时间点类(Time-Point)渲染组件

包括：饼状图、柱状排序图、漏斗图和卡片组件。

时间点类渲染组件是按照指定的批次时间渲染非连续的统计数据。

举例，比如有以下统计项：

```
统计项1：<stat-item title="每天_订单量" stat="count()" />  TimeParam:1-day
统计项2：<stat-item title="每天_各业务线_销售额" stat="sum(amount)" dimens="biz" />  TimeParam:1-day
统计项3：<stat-item title="每小时_各省份_uv数据" stat="bitcount(uid)" dimens="province" />  TimeParam:1-hour
```

针对天粒度统计指标（如上述统计项1）使用卡片素材展示昨天的订单量，时间批次为昨天；
针对天粒度统计指标（如上述统计项2）使用饼状图展示昨天各业务的销售额，时间批次为昨天；
针对小时粒度统计指标（如上述统计项3）使用柱状排序图展示上一个小时各省份的uv数据，时间批次为上一小时；

### 5.3 两类图形组件的异同

上述两类图形组件，在进行设置时，相同类别的组件设置几乎相同，不同类别的组件设置略有不同。

相同点为：
+ 都可以绑定一个或多个统计项；
+ 都可以进行筛选维度和非筛选维度的设置；

不同点为：
+ 时间段类图形组件需要指定默认渲染的时间周期或绑定日期筛选组件。
+ 时间点类图形组件需要设置"批次"。
  
时间点类图形组件的批次使用下拉框展示，以当前数据查询时间为基点进行计算，包含以下几种类型的属性值：
  
+ t-1：上一个批次；
+ t-5：上5个批次；
+ t-10：上10个批次；
+ t-5m：5分钟时间之前的批次；
+ t-1h：1小时之前的批次；
+ t-1d：一天前的批次；
+ t-30d：30天前的批次；
+ t-1y：一年前的批次。 

比如针对以下统计项：  
```
<stat-item title="每小时_各省份_uv数据" stat="bitcount(uid)" dimens="province" /> TimeParam：1-hour
```
假设：当前时间为2024-10-23 16:15:00，则当前批次时间为：2024-10-23 16:00:00 ，则：

+ t-5所表示的批次为：2024-10-23 11:00:00
+ t-1d所表示的批次为：2024-10-22 16:00:00
+ t-10d所表示的批次为：2024-10-13 16:00:00

如果您对图形渲染展示数据的时间批次不确定，可以在视图调试页面查看相关信息。

## 图形组件中的指标

一个图形组件可以绑定一个或多个统计项（时间粒度相同的统计项才能够被绑定到一起）。

系统中每个统计项都是由一个或多个统计运算函数构成，整体统计结果、每个运算函数的统计结果、Limit统计结果都是一个计算指标。在进行组件设置时您可以根据自身需要选择相应的指标进行展示。

指标可以配置指标名称（比如销售额、订单量、pv、uv、点击率等）和度量单位（比如元、万元、次、个等），针对于不同的图表，指标名称和度量单位可能会有不同的显示位置，也可能不显示。

### 图形组件中的筛选维度和非筛选维度设置

针对于有统计维度的数据指标，系统将维度分为筛选维度和非筛选维度两种，筛选维度即使用筛选框组件的交互形式查询数据指标，非筛选维度即指定默认的筛选参数，不同的维度设置意味着数据渲染使用不同的交互形式。

下面以资讯类app日志数据统计业务为例，进行阐述。

业务描述：假设资讯类app的帖子分为几个类别：新闻时政、科技、娱乐、影视、汽车、房产等，基于个性化推荐策略向用户推荐感兴趣的帖子。根据用户的点击量、点击率等指标衡量业务进展情况。

比如针对下面的数据指标：

```
<stat-item title="每天_各类别_各行为类型_日志量" stat="count()" dimens="top_level;behavior_type" />

top_level:表示帖子类别，包括：新闻时政、科技、娱乐、影视、汽车、房产等；
behavior_type:表示日志行为类型，包括：曝光、点击等；
```

针对于该数据指标，图表的交互形式可分为以下几种情况：
```
场景一：帖子类别和行为类型都使用筛选组件，这种情况在查询数据时需要同时指定两个维度的筛选参数。
场景二：帖子类别使用筛选组件，行为类型指定默认筛选参数，这种情况在查询数据时，只要设置帖子类别的筛选参数即可。
场景三：日志行为类型使用筛选组件，帖子类别指定默认筛选参数，这种情况在查询数据时，只要设置日志行为类型的筛选参数即可。
场景四：帖子类别和日志行为类型都使用默认筛选参数，这种情况图表会直接渲染出来，不需要额外指定筛选参数。
```

要实现上述场景一的需求，操作步骤如下：

+ (1)、添加一个折线图组件到视图中；
+ (2)、添加帖子类别top_level和日志行为类型behavior_type的筛选组件到视图中；
+ (3)、选择折线图组件，点击"组件配置"按钮。
+ (4)、在"基础配置"Tab标签页中绑定该统计项；
+ (5)、在"数据配置"Tab标签页中将两个筛选组件和该折线图表进行绑定（已选择状态才会生效）；
+ (6)、预览组件，然后保存。

![XL-LightHouse](https://lighthousedp-1300542249.cos.ap-nanjing.myqcloud.com/5001/3.jpg)

要实现上述场景二的需求，操作步骤如下：
+ (1)、添加一个折线图组件到视图中；
+ (2)、添加帖子类别top_level筛选组件到视图中；
+ (3)、选择折线图组件，点击"组件配置"按钮。
+ (4)、在"基础配置"Tab标签页中绑定该统计项；
+ (5)、在"数据配置"Tab标签页中将top_level筛选组件和该折线图表进行绑定；（已选择状态才会生效）
+ (6)、在"数据配置"Tab标签页，非筛选项设置中指定behavior_type的展示值；（已选择状态才会生效）
+ (7)、预览组件，然后保存。

其中非筛选设置有两种配置方式：
+ a、使用默认配置，随机选择指定数量的behavior_type属性值，系统默认打开该配置，可以手动关闭；
+ b、手动设置behavior_type的属性值，如下图所示。

两种设置方式可以并存，也可以只使用一种方式，点击"取消"按钮可以关闭该非筛选项参数的显示。

务必注意一点：在筛选维度设置中所填写的是维度字段名称，在非筛选项设置中所填写的是维度的字段值。

![XL-LightHouse](https://lighthousedp-1300542249.cos.ap-nanjing.myqcloud.com/5001/4.jpg)

上述场景三的配置方式与场景二逻辑基本相同，不再赘述。

要实现上述场景四的需求，操作步骤如下：

+ (1)、添加一个折线图组件到视图中；
+ (2)、选择折线图组件，点击"组件配置"按钮。
+ (3)、在"基础配置"Tab标签页中绑定该统计项；
+ (4)、在"数据配置"Tab标签页，非筛选项设置中指定top_level和behavior_type的展示值。（已选择状态才会生效）
+ (5)、预览组件，然后保存。

![XL-LightHouse](https://lighthousedp-1300542249.cos.ap-nanjing.myqcloud.com/5001/5.jpg)

### Table组件配置

Table组件可以将多个数据指标聚合到一个表格中展示。默认展示逻辑为：

+ 如果数据指标的批次时间不同，则不同批次时间的数据显示在不同行，并按批次时间的倒序进行展示。
+ 如果数据指标存在维度属性值，则默认首先按照批次时间倒序，然后按照维度属性值顺序展示，不同维度值的数据展示在不同行。
+ 如果表格中存在多个数据指标，批次时间和维度值相同的情况下会被聚合在一行显示。
+ 如果表格中存在多个数据指标，批次时间或维度值不相同的情况下会被分成多行显示。
+ 表格的Header属性值与统计指标的名称对应。
+ 表格可以绑定日期筛选组件和维度筛选组件。


如果您有任何使用问题或者当前视图渲染逻辑未能满足您的业务需求，请您联系开发者~































